import fitz  # pymupdf
import re


PDF_PATH = "./knowledge_base/book_test_1.pdf"
OUT_MD = "./knowledge_base/book_parsed.md"

H1 = [
    "ВВЕДЕНИЕ",
    "ЗНАКОМЬТЕСЬ: ВАША БЕССОННИЦА",
    "КОГНИТИВНО-ПОВЕДЕНЧЕСКАЯ ТЕРАПИЯ БЕССОННИЦЫ",
    "НЕДЕЛЯ 1. ИЗУЧЕНИЕ ОСНОВ ФИЗИОЛОГИИ СНА",
    "НЕДЕЛЯ 2. МЕТОДИКИ ОГРАНИЧЕНИЯ СНА И КОНТРОЛЯ СТИМУЛА",
    "КАК СОХРАНИТЬ МОТИВАЦИЮ ДО КОНЦА ПРОГРАММЫ",
    "НЕДЕЛЯ 3. ОБРАЗ ЖИЗНИ И ГИГИЕНА СНА",
    "НЕДЕЛЯ 4. РАБОТА С НЕГАТИВНЫМИ МЫСЛЯМИ И УБЕЖДЕНИЯМИ",
    "НЕДЕЛЯ 5. ТЕХНИКИ РЕЛАКСАЦИИ",
]

H2 = [
    # Знакомьтесь: ваша бессонница
    "А у вас точно бессонница?",
    "Причины бессонницы",
    "Бессонница как симптом",
    "Бессонница как болезнь",
    "Почему при хронической бессоннице не помогают снотворные?",

    # КПТ бессонницы
    "О методе",
    "Программа когнитивно-поведенческой терапии бессонницы доктора Бузунова",
    "Противопоказания к когнитивно-поведенческой терапии",
    "Как работать с книгой, чтобы получить наилучшие результаты?",

    # Неделя 1
    "Исходная оценка режима сна и бодрствования",
    "Физиология сна",
    "Оценка режима сна и бодрствования. Дневник сна",
    "Тяжесть нарушений сна",
    "Резюме по рекомендациям к неделе 1",
    "Дневник сна. Неделя 1",
    "Средние показатели сна за неделю 1",

    # Неделя 2
    "Как это работает?",
    "Как проводить методику ограничения сна",
    "Как проводить методику контроля стимула",
    "Без снотворных, алкоголя, кофеина",
    "Когда будет эффект?",
    "Ограничение сна — это хорошо",
    "Чем заниматься в свободное ото сна время?",
    "Как проснуться утром, если всю ночь почти не спал?",
    "Как сохранить бодрость на протяжении дня",
    "Сколько времени соблюдать ограничение сна?",
    "Резюме по рекомендациям к неделе 2",
    "Дневник сна. Неделя 2",
    "Средние показатели сна за неделю 2",

    # Мотивация
    "Приём «Жду результата, ведь я уже получал его раньше»",
    "Приём «Мой сон вовсе не ограничили»",
    "Приём «Моему организму не требуется больше сна»",
    "Приём «Дневная сонливость, я так тебе рад!»",
    "Приём «А какие у меня варианты?»",
    "Приём «Я объективен»",
    "Приём «Моя жертва не так велика»",
    "Приём «Скоро станет легче»",
    "Кнут и пряник от доктора Бузунова",

    # Неделя 3
    "Физическая активность",
    "Кофеин",
    "Питание",
    "Резюме по рекомендациям к неделе 3",
    "Дневник сна. Неделя 3",
    "Средние показатели сна за неделю 3",

    # Неделя 4
    "Ваши негативные мысли",
    "Шаг 1. Мысленный фильтр",
    "Шаг 2. Обезоруживание негативных мыслей",
    "Резюме по рекомендациям к неделе 4",
    "Дневник сна. Неделя 4",
    "Средние показатели сна за неделю 4",

    # Неделя 5
    "Как стресс не даёт вам спать и что мы будем с этим делать",
    "Техника «Время беспокойства»",
    "Майндфулнесс (mindfulness — осознанное созерцание)",
    "Релаксационные упражнения",
    "Как провести вечер, чтобы ночью хорошо спалось",
    "Ритуал сна",
    "Резюме по рекомендациям к неделе 5",
    "Дневник сна. Неделя 5",
    "Средние показатели сна за неделю 5",
]


# --- бегущие колонтитулы (ВСЕГДА ВЫКИДЫВАЕМ) ---
PAGE_HEADERS = [
    "Оглавление",
    "Как победить бессонницу? Здоровый сон за 6 недель ",
    "ЗНАКОМЬТЕСЬ: ВАША БЕССОННИЦА",
    # "Когнитивно-поведенческая терапия бессонницы",
    # "Неделя 1. Изучение основ физиологии сна",
    "Как победить бессонницу",
    


]

# =========================
# ПОДГОТОВКА
# =========================

def normalize(text: str) -> str:
    return re.sub(r"\s+", " ", text.strip()).upper()

H1_N = {normalize(h): h for h in H1}
H2_N = {normalize(h): h for h in H2}
PAGE_HEADERS_N = {normalize(h) for h in PAGE_HEADERS}

used_headings = set()  # чтобы не было дублей
buffer = []
out_lines = []

def flush_buffer():
    if buffer:
        out_lines.append(" ".join(buffer))
        out_lines.append("")
        buffer.clear()

def is_page_header(line: str) -> bool:
    n = normalize(line)
    if n in PAGE_HEADERS_N:
        return True
    if n.isdigit() and len(n) <= 3:  # номер страницы
        return True
    return False

# =========================
# ОСНОВНАЯ ЛОГИКА
# =========================

doc = fitz.open(PDF_PATH)

for page in doc:
    text = page.get_text("text")

    for raw_line in text.split("\n"):
        line = raw_line.strip()

        if not line:
            flush_buffer()
            continue

        if is_page_header(line):
            continue

        n = normalize(line)

        # -------- H1 --------
        if n in H1_N:
            if n in used_headings:
                continue  # дубликат (колонтитул)
            used_headings.add(n)

            flush_buffer()
            out_lines.append(f"# {H1_N[n]}")
            out_lines.append("")
            continue

        # -------- H2 --------
        if n in H2_N:
            if n in used_headings:
                continue
            used_headings.add(n)

            flush_buffer()
            out_lines.append(f"## {H2_N[n]}")
            out_lines.append("")
            continue

        # -------- обычный текст --------
        buffer.append(line)

flush_buffer()

# =========================
# СОХРАНЕНИЕ
# =========================

with open(OUT_MD, "w", encoding="utf-8") as f:
    f.write("\n".join(out_lines))

print("Готово:", OUT_MD)